<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qcap.cac.dao.PrintQrcodeMapper">

	<select id="selectQrcodeByPage" parameterType="com.qcap.cac.dto.QueryQrcodeListDto" resultType="java.util.Map">
		SELECT
			EQUIP_ID id,
			'EQUIP' qrcodeType,
			'设备' qrcodeTypeName,
			EQUIP_NAME NAME,
			PROGRAM_CODE programCode,
			EQUIP_NO CODE,
			EQUIP_CODE_URL url
		FROM
			tb_equip
		<where>
			<if test="@com.qcap.cac.tools.Ognl@isNotEmpty(param.qrcodeType) and param.qrcodeType == 'POSITION'">
				EQUIP_NO = #{param.qrcodeType}
			</if>
			<if test="@com.qcap.cac.tools.Ognl@isNotEmpty(param.programCode) and param.programCode != ''">
				AND PROGRAM_CODE = #{param.programCode}
			</if>
		</where>
		
		UNION

		SELECT
			POSITION_ID id,
			'POSITION' qrcodeType,
			'岗位' qrcodeTypeName,
			POSITION_NAME NAME,
			PROGRAM_CODE programCode,
			POSITION_CODE CODE,
			POSITION_URL url
		FROM
			tb_area_position
		<where>
			<if test="@com.qcap.cac.tools.Ognl@isNotEmpty(param.qrcodeType) and param.qrcodeType == 'EQUIP'">
				POSITION_CODE = #{param.qrcodeType}
			</if>
			<if test="@com.qcap.cac.tools.Ognl@isNotEmpty(param.programCode) and param.programCode != ''">
				and PROGRAM_CODE = #{param.programCode}
			</if>
		</where>
		
		ORDER BY qrcodeType,CODE
	</select>
	
	<update id="batchUpdateQrcode" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
	        <if test="item.qrcodeType == 'POSITION'">
				UPDATE tb_area_position
				<set>
		            POSITION_URL = #{item.url}
		        </set>
		        WHERE POSITION_ID = #{item.id}
			</if>
			<if test="item.qrcodeType == 'EQUIP'">
				UPDATE tb_equip
				<set>
		            EQUIP_CODE_URL = #{item.url}
		        </set>
		        WHERE EQUIP_ID = #{item.id}
			</if>
	    </foreach>      
	</update>
	
</mapper>