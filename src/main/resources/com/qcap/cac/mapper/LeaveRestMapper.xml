<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qcap.cac.dao.LeaveRestMapper">

	<!--查询当前登录人的组织编码-->
	<select id="queryLoginOrgCode" parameterType="String" resultType="String">
	 select a.`code`
        from tb_org a
                 left join tb_manager_org b on a.id = b.org_id
                 left join tb_manager c on b.manager_id = c.id
        where c.account = #{employeeCode}
	</select>

	<select id="queryProgramCodesByEmpCode" resultType="String">
		select
		pro.PROGRAM_CODE programCode
		from tb_manager m
		left join tb_user_info info on info.user_id = m.id
		left join tb_manager_org mo on m.id = mo.manager_id
		left join tb_org o ON mo.org_id = o.id
		left join tb_program pro ON o.PROGRAM_CODE  = pro.PROGRAM_CODE
		where m.status != 3
		and m.status != 4
		and m.account like #{map.account}
	</select>


    <!--请假列表-->
	<select id="queryLeaveList" parameterType="Map" resultType="com.qcap.cac.dto.AppLeaveReq">
		SELECT
		LEAVE_ID,
		LINE_NO,
		PERSON_ID,
		WORK_NO,
		LEAVE_TYPE,
		(SELECT desc1_ FROM tbpubcode01 A WHERE A.CONFIG_CODE_ = 'LEAVE_TYPE' AND A.DESC_ = b.LEAVE_TYPE) leaveTypeName,
		PERSON_NAME,
		PERSON_MOBILE,
		LEAVE_REASON,
		LEAVE_STATUS,
		case LEAVE_STATUS
		 when 'AUDITING' then '待审批'
		 when 'PASS' then '已通过'
		 when 'REFUSE' then '未通过'
		 when 'CANCEL' then '已撤销'
		else '' END leaveStatusName,
		AUDIT_PERSON,
		DATE_FORMAT(LEAVE_START_TIME,'%Y-%m-%d %H:%i') leaveStartTime,
		DATE_FORMAT(LEAVE_END_TIME,'%Y-%m-%d %H:%i') leaveEndTime,
		LEAVE_URL,
		LEAVE_TOTAL_TIME,
		REMARK,
		AUDIT_PERSON,
		REFUSE_REASON,
		REFUSE_URL,
		DATE_FORMAT(AUDIT_TIME,'%Y.%m.%d') auditTime,
		DATE_FORMAT(CREATE_DATE,'%Y.%m.%d') createTime
		FROM tb_leave b
		where 1 = 1
		<if test="leaveStatus!=null and leaveStatus!=''">
			and b.LEAVE_STATUS = #{leaveStatus}
		</if>
		<if test="auditCode!=null and auditCode!=''">
			and FIND_IN_SET(#{auditCode},b.AUDIT_PERSON)
		</if>
		<if test="employeeCode!=null and employeeCode!=''">
			and b.WORK_NO = #{employeeCode}
		</if>
		<if test="auditPerson!=null and auditPerson!=''">
			and b.AUDIT_PERSON = #{auditPerson}
		</if>
		<if test="employeeCodeList !=null and employeeCodeList != '' ">
			and FIND_IN_SET(#{employeeCodeList},b.AUDIT_PERSON)
		</if>
		<if test="lineNo!=null and lineNo!=''">
			and b.LINE_NO &gt; #{lineNo}
		</if>
		order by b.LINE_NO desc
		limit 0,10
	</select>

	<select id="selectLeaveDetailById" parameterType="String" resultType="com.qcap.cac.dto.AppLeaveReq">
		SELECT
		LEAVE_ID,
		LINE_NO,
		PERSON_ID,
		WORK_NO,
		LEAVE_TYPE,
		(SELECT desc1_ FROM tbpubcode01 A WHERE A.CONFIG_CODE_ = 'LEAVE_TYPE' AND A.DESC_ = b.LEAVE_TYPE) leaveTypeName,
		PERSON_NAME,
		PERSON_MOBILE,
		LEAVE_REASON,
		LEAVE_STATUS,
		case LEAVE_STATUS
		 when 'AUDITING' then '待审批'
		 when 'PASS' then '已通过'
		 when 'REFUSE' then '未通过'
		 when 'CANCEL' then '已撤销'
		else '' END leaveStatusName,
		AUDIT_PERSON,
		DATE_FORMAT(LEAVE_START_TIME,'%Y-%m-%d %H:%i') leaveStartTime,
		DATE_FORMAT(LEAVE_END_TIME,'%Y-%m-%d %H:%i') leaveEndTime,
		LEAVE_URL,
		LEAVE_TOTAL_TIME,
		REMARK,
		AUDIT_PERSON,
		REFUSE_REASON,
		REFUSE_URL,
		DATE_FORMAT(AUDIT_TIME,'%Y.%m.%d') auditTime,
		DATE_FORMAT(CREATE_DATE,'%Y.%m.%d') createTime
		FROM tb_leave b where  LEAVE_ID = #{leaveId}
	</select>
	
	<select id="selectAreaCodeByEmployCode" parameterType="String" resultType="String">
		SELECT
			AREA_CODE
		FROM
			tb_area_position
		WHERE
			POSITION_CODE = (
				SELECT DISTINCT
					POSITION_CODE
				FROM
					tb_task_arrangement
				WHERE
					EMPLOYEE_CODE = #{employeeCode}
					AND SHIFT = #{shift}
				LIMIT 1
			)
		LIMIT 1
	</select>

</mapper>
