<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qcap.cac.dao.GoodsApplyRestMapper">

	<!--查询当前登录人的角色-->
	<select id="queryLoginRole" parameterType="String" resultType="Integer">
	 select a.num
        from tb_role a
                 left join tb_manager_role b on a.num = b.role_id
                 left join tb_manager c on b.manager_id = c.id
        where c.id = #{employeeId}
	</select>


	<!--查询主管对应的岗位-->
	<select id="queryPositionIdByEmployeeId" parameterType="String" resultType="String">
	/* select a.num
        from tb_role a
                 left join tb_manager_role b on a.num = b.role_id
                 left join tb_manager c on b.manager_id = c.id
        where c.id = #{employeeId}*/
	</select>

	<!--查询角色为主管的用户-->
	<select id="queryEmployeeIdByRole" parameterType="Integer" resultType="String">
	  select c.id
        from tb_role a
                 left join tb_manager_role b on a.num = b.role_id
                 left join tb_manager c on b.manager_id = c.id
        where a.num = 1 AND LENGTH(IFNULL(c.id,'')) > 0
	</select>

    <!--库管领用单列表-->
	<select id="queryReqList" parameterType="Map" resultType="com.qcap.cac.dto.GoodsReqRestReq">
	SELECT
	WAREHOUSE_REQU_ID,
	STOREROOM_ID,
	STOREROOM,
	REQU_BATCH_NO,
	REQU_PERSON,
	REQU_MOBILE,
	REQU_NAME,
	a.POSITION_ID,
	(select b.POSITION_NAME from tb_area_position b where a.POSITION_ID = b.POSITION_ID) positionName,
	DATE_FORMAT(REQU_TIME,'%Y-%m-%d') requTime,
	DATE_FORMAT(CREATE_DATE,'%Y-%m-%d %H:%i:%s') createDate,
	REQU_REMARK,
	REQU_STATUS
	from tb_warehouse_requ a
	LEFT JOIN tb_warehouse_requ b
    on a.WAREHOUSE_REQU_ID = b.WAREHOUSE_REQU_ID
	WHERE DATE(a.REQU_TIME) =#{date}
	/*AND FIND_IN_SET(#{positionId},POSITION_ID)*/
	AND b.REQU_STATUS =#{requStatus}
	</select>


	<!--库管查询领用明细-->
	<select id="queryReqDetailList" parameterType="Map" resultType="com.qcap.cac.dto.GoodsReqDetailReq">
	 SELECT
	    a.WAREHOUSE_REQU_ID,
        WAREHOUSE_REQDETAIL_ID,
        a.GOODS_NO  goodsNo,
        a.GOODS_NAME goodsName,
        APPLY_NUM,
        REAL_NUM,
        MIN_UNIT,
        (SELECT IFNULL(SUM(GOODS_NUM),0) FROM tb_warehouse_stock c WHERE c.GOODS_NAME = a.GOODS_NAME) goodsNum,
        a.REQU_REMARK
        from tb_warehouse_reqdetail a
        LEFT JOIN tb_warehouse_requ b
        on a.WAREHOUSE_REQU_ID = b.WAREHOUSE_REQU_ID
        where  a.WAREHOUSE_REQU_ID = #{warehouseRequId}
        AND a.REQU_STATUS =#{requStatus}
        order by a.GOODS_NO
	</select>


	<!--主管查询发放-->
	<select id="queryAvailDistributionList" parameterType="Map" resultType="com.qcap.cac.dto.GoodsDistributionDetailReq">
	SELECT a.ids,a.goodsNo,a.goodsName,(a.realNum - b.distrNum) availNum,a.minUnit
	FROM
	(SELECT
	  GROUP_CONCAT(a.WAREHOUSE_REQDETAIL_ID) ids,
		a.GOODS_NO goodsNo,
		a.GOODS_NAME goodsName,
		SUM(a.REAL_NUM) realNum,
		a.MIN_UNIT minUnit
	FROM
		tb_warehouse_reqdetail a
	WHERE
		REQU_STATUS = 'RECEIVE'
	GROUP BY
		a.GOODS_NO
	ORDER BY
		a.GOODS_NO) a,
	(SELECT
		b.WAREHOUSE_REQDETAIL_ID ids,
		b.GOODS_NO goodsNo,
		b.GOODS_NAME goodsName,
		SUM(b.DISTR_NUM) distrNum,
		b.MIN_UNIT minUnit
	FROM
		tb_warehouse_distribution  b
	GROUP BY
		b.WAREHOUSE_REQDETAIL_ID
	ORDER BY
		b.GOODS_NO) b where a.ids = b.ids


	</select>
	
	
	
</mapper>
